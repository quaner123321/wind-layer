<!DOCTYPE html>
<html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Map - Display a map</title>
<link rel="stylesheet" href="https://unpkg.com/dat.gui@0.7.6/build/dat.gui.css">
<link rel="stylesheet" href="https://unpkg.com/maptalks/dist/maptalks.css">
<style type="text/css">
  html, body {
    margin: 0;
    height: 100%;
    width: 100%
  }
  .container {
    width: 100%;
    height: 100%
  }
</style>
<body>

<div id="map" class="container"></div>
<script src="https://unpkg.com/maptalks/dist/maptalks.js"></script>
<script src="https://unpkg.com/axios/dist/axios.js"></script>
<script src="https://unpkg.com/dat.gui@0.7.6/build/dat.gui.js"></script>
<script src="../packages/maptalks/dist/maptalks-wind.js"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/@sakitam-gis/maptalks-wind/dist/maptalks-wind.js"></script> -->
<script>
  const map = new maptalks.Map('map', {
    // center: [113.53450137499999, 34.44104525],
    zoom: 2,
    center: [34.371, 131.287].reverse(),
    // zoom: 4
    baseLayer: new maptalks.TileLayer('base', {
      urlTemplate: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
      // urlTemplate: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
      subdomains: ['a', 'b', 'c', 'd'],
    })
  });

  window.map = map;

  mtkWind.configDeps(['https://unpkg.com/geotiff/dist-browser/geotiff.js']);

  const tileSource = new mtkWind.TileSource('wind', {
    tileSize: 256,
    minZoom: 0,
    maxZoom: 4,
    roundZoom: true,
    decodeType: mtkWind.DecodeType.imageWithExif,
    wrapX: false,
    url: 'http://192.168.2.33:5000/2023111700/2023111703/{z}/{x}/{y}/wind-surface.jpeg',
  });

  const imageSource22 = new mtkWind.ImageSource('wind-555', {
    decodeType: mtkWind.DecodeType.imageWithExif,
    coordinates: [
      [-180, 85.051129],
      [180, 85.051129],
      [180, -85.051129],
      [-180, -85.051129],
      // [116, 42.5],
      //     [129, 42.5],
      //     [129, 28.5],
      //     [116, 28.5],
    ],
    wrapX: false,
    url: 'http://192.168.2.33:5000/2023111700/2023111703/0/0/0/wind-surface.jpeg',
  });


  const imageSource = new mtkWind.ImageSource('wind-2', {
    decodeType: mtkWind.DecodeType.imageWithExif,
    coordinates: [
      [-180, 85.051129],
      [180, 85.051129],
      [180, -85.051129],
      [-180, -85.051129],
      // [116, 42.5],
      //     [129, 42.5],
      //     [129, 28.5],
      //     [116, 28.5],
    ],
    wrapX: false,
    url: 'http://192.168.2.33:5000/2023111700/2023111703/0/0/0/wind-surface.jpeg',

  });

  const imageSource1 = new mtkWind.ImageSource('wind-333', {
    decodeType: mtkWind.DecodeType.imageWithExif,
    coordinates: [
      // [-180, 85.051129],
      // [180, 85.051129],
      // [180, -85.051129],
      // [-180, -85.051129],
      [116, 42.5],
          [129, 42.5],
          [129, 28.5],
          [116, 28.5],
    ],
    wrapX: false,
    url: 'http://192.168.2.33:5000/2023111700/2023111703/0/0/0/wind-surface.jpeg',
  });

  const color = {
    temp: [[203,[115,70,105,255]],
      [218,[202,172,195,255]],
      [233,[162,70,145,255]],
      [248,[143,89,169,255]],
      [258,[157,219,217,255]],
      [265,[106,191,181,255]],
      [269,[100,166,189,255]],
      [273.15,[93,133,198,255]],
      [274,[68,125,99,255]],
      [283,[128,147,24,255]],
      [294,[243,183,4,255]],
      [303,[232,83,25,255]],
      [320,[71,14,0,255]]],
    wind: [[0,[98,113,183,255]],
      [1,[57,97,159,255]],
      [3,[74,148,169,255]],
      [5,[77,141,123,255]],
      [7,[83,165,83,255]],
      [9,[53,159,53,255]],
      [11,[167,157,81,255]],
      [13,[159,127,58,255]],
      [15,[161,108,92,255]],
      [17,[129,58,78,255]],
      [19,[175,80,136,255]],
      [21,[117,74,147,255]],
      [24,[109,97,163,255]],
      [27,[68,105,141,255]],
      [29,[92,144,152,255]],
      [36,[125,68,165,255]],
      [46,[231,215,215,256]],
      [51,[219,212,135,256]],
      [77,[205,202,112,256]],
      [104,[128,128,128,255]]]
  };

  const interpolateColor = color.wind.reduce((result, item, key) => result.concat(item[0] - 0/*273.15*/, 'rgba(' + item[1].join(',') + ')'), []);

  const fill = new mtkWind.Layer('fill', imageSource22, {
    wireframe: true,
    styleSpec: {
      'fill-color': [
        'interpolate',
        ['step', 1],
        ['get', 'value'],
        ...interpolateColor
      ],
      'opacity': 0.6
    },
    renderFrom: mtkWind.RenderFrom.rg,
    widthSegments: 64,
    heightSegments: 64,
    displayRange: [0, 104],
    renderType: mtkWind.RenderType.colorize,
    picking: true,
    // mask: {
    //   data: clip,
    //   // type: mapboxWind.MaskType.outside,
    //   type: mapboxWind.MaskType.inside, // 默认是 inside，即只显示范围内的
    // }
  });

  const particlesConfig = {
    speedFactor: 0.5,
    fadeOpacity: 0.93,
    dropRate: 0.003,
    dropRateBump: 0.002,
  }

  const layer = new mtkWind.Layer('wind', imageSource, {
    styleSpec: {
      'fill-color': [
        'interpolate',
        ['step', 1],
        ['get', 'value'],
        0, '#fff',
        104, '#fff',
      ],
      'opacity': 0.4,
      numParticles: [
        'interpolate',
        ['exponential', 0.5],
        ['zoom'],
        0, // zoom
        65535 / 8, // numParticles
        8, // zoom
        65535 / 16 // numParticles
      ],
      ...particlesConfig,
    },
    renderFrom: mtkWind.RenderFrom.rg,
    widthSegments: 1,
    heightSegments: 1,
    displayRange: [0, 104],
    renderType: mtkWind.RenderType.particles,
    // picking: true
  });

  



  const arrow = new mtkWind.Layer('arrow', imageSource1, {
    styleSpec: {
      
      'opacity': 1.0,
      space: 100,
      size: [140, 140],
    },
    renderFrom: mtkWind.RenderFrom.rg,
    displayRange: [0, 104],
    renderType: mtkWind.RenderType.number,// arrow,   barb  number
    lineWidthFactor: 2.0, // 新增：线宽因子，1.0为默认，越大越粗
    picking: true,
    // mask: {
    //   data: clip,
    //   // type: mapboxWind.MaskType.outside,
    //   type: mapboxWind.MaskType.inside, // 默认是 inside，即只显示范围内的
    // }
  });

  fetch('./data/china.geojson').then(res => res.json()).then(clip => {
    // fill.setClipMask({
    //   data: clip,
    //   // type: mtkWind.MaskType.outside,
    //   type: mtkWind.MaskType.inside, // 默认是 inside，即只显示范围内的
    // })

    // layer.setClipMask({
    //   data: clip,
    //   // type: mtkWind.MaskType.outside,
    //   type: mtkWind.MaskType.inside, // 默认是 inside，即只显示范围内的
    // })

    // console.log(clip);
    // const mask = maptalks.Geometry.fromJSON(clip);
    // arrow.setMask(mask)


    console.log(clip);
    const features = clip.features;
    if (features && features.length > 0) {
        const geometry = features[0].geometry;
        
        // 创建正确的 JSON 结构给 fromJSON
        const maskJson = {
            type: geometry.type,
            coordinates: geometry.coordinates
        };
        const mask = maptalks.Geometry.fromJSON(maskJson);
        // arrow.setMask(mask);
    }


  });

  
  map.addLayer(fill);
  map.addLayer(layer);
  map.addLayer(arrow);
</script>
</body>
</html>
